<html>
<head>
</head>
<body>
  <h3>Events CSV input</h3>
  <textarea id="csv_input" rows=5></textarea>
  <div><button onclick="parseCSVtoJSON();">Parse</button></div>
  <h3>Events JSON output</h3>
  <textarea id="json_output" rows=5></textarea>
  <script src="scripts/csvtojson.min.js"></script>
  <script src="scripts/moment.min.js"></script>
  <script src="scripts/moment-timezone-with-data.min.js"></script>
  <script>
    var dateTimeOutputFormat = "YYYY-MM-DD[T]HH:mm:ss[Z]";
    var timezone = "Europe/Stockholm";

    moment.tz.setDefault(timezone);

    function parseCSVtoJSON() {
      var csvString = document.querySelector("#csv_input").value;

      csv({
        output: "json"
      })
      .fromString(csvString)
      .then(function(result){
        console.log(result);
        var outputJSON = processRawEventJSON(result);
        console.log(outputJSON);
        document.querySelector("#json_output").value = JSON.stringify(outputJSON);
        document.querySelector("#json_output").select();
        document.execCommand('copy');
      });
    }

    function processRawEventJSON(eventJSON) {
      var processedEventJSON = [];
      for (var i = 0; i < eventJSON.length; i++) {
        var event = {
          "title": eventJSON[i].title,
          "description": eventJSON[i].description,
          "location": eventJSON[i].location,
          "startTime": moment(eventJSON[i].startTime).tz("Etc/UTC").format(dateTimeOutputFormat),
          "endTime": moment(eventJSON[i].endTime).tz("Etc/UTC").format(dateTimeOutputFormat),
          "eventTags": eventJSON[i].eventTags.split(", ")
        }
        if (event.description == "") {
          event.description = eventJSON[i]["internal_description"];
        }
        if (event.eventTags.indexOf("secret") == -1 && event.eventTags.indexOf("private") == -1 && event.eventTags.indexOf("cancelled") == -1) {
          processedEventJSON.push(event);
        }
      }
      return processedEventJSON;
    }
  </script>
</body>
</html>
